<!DOCTYPE html>
<html>
<head>
<title>Rainbows</title>
<style>
@font-face {
  font-family: GoodDog;
  src: url("fonts/GoodDog-regular/GoodDog.otf") format("opentype");
}
body {
  background-color: lightblue;
}
table {
  margin-left: auto;
  margin-right: auto;
}
body, h1, p {
  text-align: center;
  font-family: GoodDog;
}
h1 {
  font-size: 400%;
}
h2 {
  font-style: italic;
  font-size: 300%;
}
p {
  font-size: 150%;
}
.CodeMirror {
  text-align: left;
  width: 50em;
  border: solid;
  border-color: lightgrey;
  background-color: #E0E9EC !important;
}
.CodeMirror-gutters {
  background-color: #DAE5E8 !important;
}
.code-box {
  height: auto;
  display: table;
  width: auto;
  display: inline-block;
}
.container {
  height: 100%;
  float: right;
  margin-top: 20px;
  margin-left: 10px;
}
button.selector {
  position: relative;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="lib/codemirror/lib/codemirror.js"></script>
<script type="text/javascript" src="lib/codemirror/mode/rainbows/rainbows.js"></script>
<script type="text/javascript" src="lib/codemirror/mode/javascript/javascript.js"></script>
<link rel="stylesheet" type="text/css" href="lib/codemirror/lib/codemirror.css">
<link rel="stylesheet" type="text/css" href="src/rainbows-types.css">
<link rel="stylesheet" type="text/css" href="lib/hint.min.css">
<script>
var editor;
var jscode;
// these are fake initializations! TODO: make this empty
env = {};

function addType(node, type) {
  node.addClass('rb-type-' + type);
  node.addClass('hint--top');
  node.attr('aria-label', type);
  return node;
}
function appendTypeClass(originalClassName) {
  $(originalClassName).each(function() {
    var output = $(this).text();
    var oldClass;
    try {
      if (oldClass = $(this).attr('class').match(/rb-type-\S+/)[0]) {
        $(this).removeClass(oldClass);
      }
    } catch(e) {
    }
    if (originalClassName === '.cm-number') {
      if ($(this).text().match(/.*\..*/))
        addType($(this), 'float');
      else
        addType($(this), 'int');
    } else if (originalClassName === '.cm-string') {
      addType($(this), 'string');
    } else if (env[output]) {
      addType($(this), env[output]);
    }
  });
}
function main() {
  env = {};
  // literals
  appendTypeClass('.cm-number');
  appendTypeClass('.cm-string');

  // definitions (of known ids)
  appendTypeClass('.cm-def');

  // variable references and re-assignments (of known ids)
  appendTypeClass('.cm-variable');
  appendTypeClass('.cm-variable-2');

  // figure out LHS of any assignments (esp. definitions!)
  $('.cm-operator').filter(function() {
    return $(this).text() === "=";
  }).each(function() {
    try {
      var typeRHS = $(this).next().attr('class').match(/rb-type-(\S+)/)[1];
    } catch(e) {
      typeRHS = env[$(this).next().text()];
    }
    if (typeRHS === undefined)
      return;
    var text = $(this).prev().text();
    if (env[text] && env[text] !== typeRHS)
      console.warn('warning: types ' + env[text] + ' and ' + typeRHS + ' conflict');
    addType($(this).prev(), typeRHS);
    addType($(this).next(), typeRHS); // for safe measure
    env[text] = typeRHS;
  });

  // figure out more stuff
}

$(document).ready(function(){
  var code = $('.codemirror-textarea')[0];
  editor = CodeMirror.fromTextArea(code, {
    mode: "rainbows",
    lineNumbers: true
  });
  var output = $('.codemirror-textarea')[1];
  jscode = CodeMirror.fromTextArea(output, {
    readOnly: true,
    lineNumbers: true
  });

  editor.on('change', delayedMain);
  main();
});
function delayedMain() { // a total hack!
  setTimeout(main, 1);
}
function selectAll(id) {
  document.getElementById(id).select();
}
</script>
</head>
<body>
<h1>
  <span class="rb-type-string">R</span><span class="rb-type-dict">a</span><span class="rb-type-int">i</span><span class="rb-type-list">N</span><span class="rb-type-string">B</span><span class="rb-type-dict">o</span><span class="rb-type-int">W</span><span class="rb-type-list">s</span>
</h1>
<p>Like it? Check out the project <a href="https://github.com/nfischer/rainbows">on Github</a></p>
<table>
<tr>
<td>
<div class="code-box">
<h2>Rainbows code</h2>
<textarea id="rainbows" class="codemirror-textarea">
// Recursive fibonacci algorithm
function fib(n) {
  if (n == 0) {
    return 0;
  } else if (n == 1) {
    return 1;
  } else {
    return fib(n-1)+fib(n-2);
  }
}

var output = fib(12);
var msg = "hello world";
</textarea>
</div>
</td>
</tr>
<tr>
<td>
<div class="code-box">
<h2>Ignore this box for now &#9786;</h2>
<textarea id="jscode" class="codemirror-textarea">
</textarea>
<div class="container">
<input type="button" class="selector" value="Select this script" onclick="jscode.execCommand('selectAll'); jscode.focus()" id="button2">
</div>
</div>
</td>
</tr>
</table>
</body>
</html>
