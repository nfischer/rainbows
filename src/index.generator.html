<!DOCTYPE html>
<html>
<head>
<title>Rainbows</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script type="text/javascript" src="lib/codemirror/lib/codemirror.js"></script>
<script type="text/javascript" src="lib/codemirror/mode/rainbows/rainbows.js"></script>
<script type="text/javascript" src="lib/codemirror/mode/javascript/javascript.js"></script>
<link rel="stylesheet" type="text/css" href="lib/codemirror/lib/codemirror.css">
<link rel="stylesheet" type="text/css" href="lib/hint.min.css">
<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/smoothness/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="src/rainbows-types.css">
<link rel="stylesheet" type="text/css" href="src/main.css">
<script type="text/javascript" src="src/index.js"></script>
<script type="text/javascript" src="src/rb-examples.js"></script>
<script type="text/javascript" src="lib/ohm/dist/ohm.min.js"></script>
<script type="text/javascript" src="src/inference.js"></script>
<script type="text/javascript" src="src/interp.js"></script>
<script type="text/ohm-js" src="src/rainbows.ohm"></script>
<script type="text/ohm-js" src="lib/ohm/examples/ecmascript/es5.ohm"></script>
<script type="text/javascript">
  var s;
  var grammars;
  $(document).ready(function() {
    grammars = ohm.grammarsFromScriptElements();
    s = grammars.ES5.semantics();
    s.addOperation(
        'ti()',
        typeInference);
    s.addOperation(
        'rb()',
        rbInterp);
  });

  function interp(expr) {
    var m = grammars.ES5.match(expr);
    if (m.succeeded()) {
      return s(m).rb();
    } else {
      throw "Error";
    }
  }

  // This accepts a javascript expression and returns a string denoting its type
  function getJsType(expr) {
    var widget;
    var m = grammars.ES5.match(expr);
    if (m.succeeded()) {
      return s(m).ti();
    //} else {
    //  var timeout;
    //  editor.on('keyHandled', function() {
    //    if(timeout) {
    //      clearTimeout(timeout);
    //      timeout = null;
    //      setTimeout(function() {
    //        if (widget) widget.clear();
    //        widget = null;
    //      }, 200);
    //    }
    //  });
    //  timeout = setTimeout(function() {
    //    if (m.message) {
    //      try {
    //        var lineNum = m.message.match(/Line: (\d+),/)[1];
    //      } catch(e) {
    //        lineNum = 14;
    //      }
    //      var d = document.createElement('div');
    //      d.appendChild(document.createTextNode(m.message));
    //      widget = widget || editor.addLineWidget(parseInt(lineNum), d);
    //    }
    //  }, 30);
    }
  }
</script>
<script type="text/javascript">
  var updateSlider;
  $(document).ready(function() {
    editor.setValue(rbExamples[0].code);
    env = Object.assign({}, defaultEnv); // copy the default environment
    // Add buttons for the other examples
    var table = document.getElementById('main-table');
    var row = table.insertRow(1);
    var mydiv = document.createElement('div');
    row.appendChild(mydiv);
    rbExamples.forEach(function(ex) {
      var button = document.createElement('button');
      button.appendChild(document.createTextNode(ex.name));
      mydiv.appendChild(button);
      $(button).click(function() {
        env = Object.assign({}, defaultEnv); // copy the default environment
        editor.setValue(ex.code);
      });
    });
  });
  $(function() {
    var rbTypeList = ['no type', 'string', 'int', 'float', 'bool', 'list', 'dict'];
    var matchingGrey = $('.cm-s-default').css('color');
    var rbColorList = rbTypeList.map(x => $('.rb-type-' + x).css('color') || matchingGrey);
    var node = {}; // hack: use an object here, because of scoping issues
    updateSlider = function (event, ui) {
      var myType = rbTypeList[ui.value];
      node.value.css('background', rbColorList[ui.value]);

      // Remember the user's type selection
      setEnv(window.currentToken, (myType === 'no type' ? 'unknown' : myType));

      addType(node.value, myType); // show the link hint for the slider UI
      addType($('#cur-token'), myType); // show the link hint for the slider UI
      main(); // infer types, but now we'll remember the user's manual change
    }
    $('#slider-1').slider({
      min: 0,
      max: rbTypeList.length - 1,
      value: 0,
      slide: updateSlider,
    });
    node.value = $('.ui-state-default');
    node.value.css('background', matchingGrey);
    $('.ui-widget-content').css('background', '#E0E9EC');
    $('#slider-1').slider('option', 'disabled', true);
  })
</script>
</head>
<body>
<p hidden>
  <!-- This is to make sure we have at least one instance of each rb-type class -->
  <div class="rb-type-bool"></div>
  <div class="rb-type-string"></div>
  <div class="rb-type-int"></div>
  <div class="rb-type-float"></div>
  <div class="rb-type-dict"></div>
  <div class="rb-type-list"></div>
</p>
<h1>
  <span class="rb-type-string">R</span><span class="rb-type-dict">a</span><span class="rb-type-int">i</span><span class="rb-type-list">N</span><span class="rb-type-string">B</span><span class="rb-type-dict">o</span><span class="rb-type-int">W</span><span class="rb-type-list">s</span>
</h1>
<p>Like it? Check out the project <a href="https://github.com/nfischer/rainbows">on Github</a></p>
<div class="code-box">
<table id="main-table">
<tr>
<td>
<h2>Rainbows code</h2>
<textarea id="rainbows-text" class="codemirror-textarea">
</textarea>
</div>
</td>
<td>
<div class="color-changer">
<p id="msg"></p>
<div id="slider-1" myval="40"=></div>
</div>
</td>
</tr>
<tr>
<td>
<div class="code-box">
<h2>Ignore this box for now &#9786;</h2>
<textarea id="jscode" class="codemirror-textarea">
</textarea>
<div class="container">
<input type="button" class="selector" value="Select this script" onclick="jscode.execCommand('selectAll'); jscode.focus()" id="button2">
</div>
</div>
</td>
</tr>
</table>
</body>
</html>
